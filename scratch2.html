<!DOCTYPE html>
<meta charset="utf-8">
<style>

    body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        margin: auto;
        position: relative;
        width: 960px;
    }

    text {
        font: 10px sans-serif;
    }

    form {
        position: absolute;
        right: 10px;
        top: 10px;
    }

</style>
<form>
    <input type="button" name="dataset" value="add">
    <input type="button" name="dataset" value="subtract">
</form>
<script src="//d3js.org/d3.v3.min.js"></script>
<script>
    var amount = 0;

    var arcCurrent;
    var phantomCurrent;

    var width = 480,
        height = 250,
        radius = Math.min(width, height) / 2;

    var center = width / 2;

    var pie = d3.layout.pie()
        .padAngle(0.05)
        .value(function(d) { return d["checked"]; })
        .sort(null);

    var arc = d3.svg.arc()
        .innerRadius(radius - 50)
        .outerRadius(radius - 20)
        .startAngle((d) => d.startAngle + 0.065)
        .endAngle((d) => d.endAngle + 0.065);
    //
    // var arcPhantom = d3.svg.arc()
    //     .innerRadius(0)
    //     .outerRadius(radius - 10);

    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);

    d3.json("data.json", function(error, data) {
        if (error) throw error;

        var path = svg.datum(data).selectAll("g.arc")
            .data(pie)
            .enter()
            .append("g")
            .attr("class", "arc")
            .attr("transform", "rotate(" + 25 + ")")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
            .append("path")
            .attr("fill", "#ff7f0e")
            // .attr("fill", function(d, i) {
            //     if (i % 2 === 0) {
            //         return "#ff7f0e";
            //     }
            //     return "white";
            // })
            .attr("d", arc)
            .each(function(d) { this._current = d; }); // store the initial angles

        // var phantomArcs = svg.datum(data).selectAll("g.phantom-arc")
        //     .data(pie)
        //     .enter()
        //     .append("g")
        //     .attr("class", "phantom-arc")
        //     .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
        //     .append("path")
        //     .attr("fill", 'white')
        //     .attr("fill-opacity", 0.1)
        //     .attr("d", arcPhantom)
        //     .style('stroke', 'white')
        //     .style('stroke-width', 5)
        //     .each(function(d) { this._current = d; });

        d3.selectAll("input")
            .on("click", change);

        // var timeout = setTimeout(function() {
        //     d3.select("input[value=\"add\"]").property("checked", true).each(change);
        // }, 2000);

        function change() {
            var value = this.value;
            if (value === "add") {
                amount++;
                if (amount > 8) {
                    amount = 0;
                }
            }
            if (value === "subtract") {
                amount--;
                if (amount < 0) {
                    amount = 8;
                }
            }

            var datum = [];
            for (var i = 0; i < amount; i++) {
                datum.push({
                    checked: 0,
                });
            }
            pie.value(function(d, i) {
                if (amount === 0) {
                    return 0;
                } else if (amount === 1) {
                    if (i === 1) {
                        return 1;
                    }
                    return 0;
                } else {
                    if (i < amount) {
                        return (100 / amount);
                    }
                    return 0;
                }

                // console.log(amount);
                // if (amount === 0) {
                //     return 0;
                // }
                // if (amount === 1) {
                //     if (i === 0 || i === 2) {
                //         return 50;
                //     }
                //     return 0;
                // } else {
                //     if (i < (amount)) {
                //         if (i % 2 === 0) {
                //             return (100 / amount) - 2;
                //         } else {
                //             return 1.5;
                //         }
                //     } else {
                //         var breakpoint = amount % 2 === 0 ? amount + 1 : amount;
                //         if (i === 15 || i === breakpoint) {
                //             return 1.5;
                //         } else {
                //             if (i % 2 === 0) {
                //                 return d["checked"] + (((100 / amount) - 2) / (8-amount));
                //             } else {
                //                 return 0;
                //             }
                //         }
                //     }
                // }
            }); // change the value function
            path = path.datum(datum);
            path = path.data(pie);
            // phantomArcs = phantomArcs.data(pie);
            // phantomArcs.style("stroke", () => {
            //     if (amount > 1) {
            //         return "white";
            //     } else {
            //         return "none";
            //     }
            // })
            path.transition().duration(750).attrTween("d", arcTween);
            // phantomArcs.transition().duration(750).attrTween("d", (a) => {
            //     console.log(a);
            //     return arcTween(a, 2);
            // });
        }
    });

    function type(d) {
        d.checked = amount;
        return d;
    }

    // Store the displayed angles in _current.
    // Then, interpolate from _current to the new angles.
    // During the transition, _current is updated in-place by d3.interpolate.
    function arcTween(a) {
        var i = d3.interpolate(this._current, a);
        this._current = i(0);
        return function(t) {
            return arc(i(t));
        };
    }

    function phantomArcTween(a) {
        var i = d3.interpolate(this._current, a);
        this._current = i(0);
        return function(t) {
            return arcPhantom(i(t));
        };
    }

</script>
